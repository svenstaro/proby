language: rust
dist: xenial
cache: cargo

rust:
  - stable
  - beta
  - nightly

addons:
  apt:
    packages:
      - mingw-w64
      - upx
      - musl
      - musl-dev
      - musl-tools
env:
matrix:
  allow_failures:
    - rust: stable
    - rust: beta
    - rust: nightly
      env:
      - TARGET=x86_64-pc-windows-gnu
      - BIN_NAME=proby.exe
      - PROPER_NAME=proby-win.exe
      - RUSTFLAGS="-C linker=x86_64-w64-mingw32-gcc"
      os: linux
  include:
    - env:
      - TARGET=x86_64-unknown-linux-musl
      - BIN_NAME=proby
      - PROPER_NAME=proby-linux
      os: linux
      rust: nightly
    - env:
      - TARGET=x86_64-pc-windows-gnu
      - BIN_NAME=proby.exe
      - PROPER_NAME=proby-win.exe
      - RUSTFLAGS="-C linker=x86_64-w64-mingw32-gcc"
      os: linux
      rust: nightly
    - env:
      - TARGET=x86_64-apple-darwin
      - BIN_NAME=proby
      - PROPER_NAME=proby-osx
      os: osx
      rust: nightly

before_install:
  - rustup self update

install:
  # On Apple, the default target is already the right one.
  - if [[ -n $TARGET && $TARGET != "x86_64-apple-darwin" ]]; then rustup target add $TARGET; fi

script:
  # If this is a normal, non-deployment build...
  - if [[ -z $TARGET ]]; then cargo build --verbose; fi
  - if [[ -n $TARGET ]]; then cargo build --verbose --release --target $TARGET; fi

before_deploy:
  # If this is a binary deployment...
  - if [[ -n $TARGET ]]; then cp -a target/$TARGET/release/$BIN_NAME $PROPER_NAME && strip $PROPER_NAME; fi
  - # Run upx on the binary if this is a deployment for Linux or Windows
  - if [[ $TARGET = "x86_64-pc-windows-gnu" ]]; then upx $PROPER_NAME; fi
  - if [[ $TARGET = "x86_64-unknown-linux-musl" ]]; then upx $PROPER_NAME; fi

deploy:
  - provider: releases
    api_key:
      secure: "a07wImCHn9f0yx+RE4hlgT8UfkUxpaMQOxvr+NYECTbVxd39xwoa2z0EHPffLMGsayFcy93/8qmp41B1ntkX7M1nG4XQFTWy7nyNYZtPODNXbF+ZcVzHVukFCy4UHGUnReEorGDbOdlqB9N9CQHtFguWLU7gQ/CV5XmKJsWEy1MofhN/klXSLX7g24rW5dp2ss8Bt9pzSpFvpdXkHU9NVvHDPuIa+QvTFD5rD+tRCx6B6dEcX/h6RtKlk92Pv+hFE+1PvfpqKdvKQSdjIPxbq70uJvHl4ARvO9mqrVX1nYUan9Lw0lD0XptzFYJc5qHCJDjBT93gDgG7im3c3hlY80NbxKkhdftVA9Ii4b95IHri2BCD/fuBg1Yqy/2pHj+oe+MOSPWaUcb67ZQxW8OQU0n8hNlm+4EDykdNOtYuTh7LFLTioItj9CVRPfpHWqfvcu6m3rFEL3xAjc0VPcis17kxVl9O4F6cU0ndUIl0iVDnd0p3hW/CkDNg3uUC269jaxy9YoyYoGI8gW2lYnr8DgNO7LhGx1sgqH8LETFh4tpWCeVo1iDaqfVUqX5hJpq7qKoPwmlAhZ1zwwPUdT9iJyQB1rgY4CiuxwYDmzWbQBafkTEXIlVfx+wweXTHPyaUl+6YARW0bLBZLjjlOFH0BRTao2wgWe6O2hnPTJ4Q9pI="
    file: $PROPER_NAME
    skip_cleanup: true
    on:
      branch: master
      tags: true
      condition: $TRAVIS_RUST_VERSION = nightly && -n $TARGET
